"use client";

import { Avatar } from "@heroui/avatar";
import { Badge } from "@heroui/badge";
import { Button } from "@heroui/button";
import { Card, CardBody } from "@heroui/card";
import { Tab, Tabs } from "@heroui/tabs";
import {
  ChatCircle,
  CheckCircle,
  Clock,
  Phone,
  Users,
  X,
} from "@phosphor-icons/react";
import React, { useEffect, useState } from "react";
import toast from "react-hot-toast";

import { humanHandoffService } from "@/services/humanHandoff";

interface PendingRequest {
  id: string;
  conversationId: string;
  userProfile?: {
    name?: string;
    email?: string;
  };
  initialMessage: string;
  requestedAt: Date;
  timeElapsed: number;
}

interface ActiveSession {
  id: string;
  conversationId: string;
  userProfile?: {
    name?: string;
    email?: string;
  };
  connectedAt: Date;
  duration: number;
}

export default function HumanSupportPage() {
  const [pendingRequests, setPendingRequests] = useState<PendingRequest[]>([]);
  const [activeSessions, setActiveSessions] = useState<ActiveSession[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [lastUpdate, setLastUpdate] = useState(Date.now());

  // Queries with more frequent updates for real-time feel
  const { data: notifications, refetch: refetchNotifications } =
    humanHandoffService.useAdminNotifications();
  const { data: sessions, refetch: refetchSessions } =
    humanHandoffService.useAdminSessions();

  // Mutations
  const acceptMutation = humanHandoffService.useAcceptHandoff();
  const endMutation = humanHandoffService.useEndHandoff();

  // Aggressive auto refresh every 2 seconds for real-time experience
  useEffect(() => {
    const interval = setInterval(() => {
      refetchNotifications();
      refetchSessions();
      setLastUpdate(Date.now());
    }, 2000);

    return () => clearInterval(interval);
  }, [refetchNotifications, refetchSessions]);

  // Handle accepting a request
  const handleAcceptRequest = async (sessionId: string) => {
    acceptMutation.mutate(sessionId, {
      onSuccess: () => {
        // Immediate refresh after action
        refetchNotifications();
        refetchSessions();
        toast.success("ƒê√£ nh·∫≠n y√™u c·∫ßu h·ªó tr·ª£! B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu chat.");
      },
    });
  };

  // Handle ending a session
  const handleEndSession = async (sessionId: string) => {
    endMutation.mutate(sessionId, {
      onSuccess: () => {
        refetchSessions();
        toast.success("ƒê√£ k·∫øt th√∫c phi√™n h·ªó tr·ª£!");
      },
    });
  };

  // Handle opening chat (simplified - just open in new tab)
  const handleOpenChat = (session: ActiveSession) => {
    const chatUrl = `/admin/manager/human-support/chat/${session.id}`;
    window.open(chatUrl, "_blank", "width=800,height=600");
    toast.success("M·ªü c·ª≠a s·ªï chat trong tab m·ªõi");
  };

  // Process notifications into pending requests
  useEffect(() => {
    if (notifications) {
      const pending = notifications
        .filter((session) => session.status === "waiting")
        .map((session) => ({
          id: session.id,
          conversationId: session.conversationId,
          userProfile: session.userProfile,
          initialMessage: session.initialMessage,
          requestedAt: session.requestedAt,
          timeElapsed: Math.floor(
            (Date.now() - new Date(session.requestedAt).getTime()) / 1000,
          ),
        }));
      setPendingRequests(pending);
    }
  }, [notifications]);

  // Process sessions into active sessions
  useEffect(() => {
    if (sessions) {
      const active = sessions
        .filter((session) => session.status === "connected")
        .map((session) => ({
          id: session.id,
          conversationId: session.conversationId,
          userProfile: session.userProfile,
          connectedAt: session.connectedAt!,
          duration: Math.floor(
            (Date.now() - new Date(session.connectedAt!).getTime()) / 1000,
          ),
        }));
      setActiveSessions(active);
    }
  }, [sessions]);

  // Enhanced Socket setup for real-time updates
  useEffect(() => {
    const cleanup = humanHandoffService.setupSocketListeners({
      onSupportAccepted: () => {
        refetchNotifications();
        refetchSessions();
        toast.success("C√≥ admin kh√°c ƒë√£ nh·∫≠n y√™u c·∫ßu!");
      },
      onSupportEnded: () => {
        refetchSessions();
        toast("M·ªôt phi√™n h·ªó tr·ª£ ƒë√£ k·∫øt th√∫c", { icon: '‚ÑπÔ∏è' });
      },
      onSupportTimeout: () => {
        refetchNotifications();
        toast("M·ªôt y√™u c·∫ßu h·ªó tr·ª£ ƒë√£ timeout", { icon: "‚ö†Ô∏è" });
      },
      onAdminNotification: (notification: any) => {
        // Force immediate refetch when new request comes in
        refetchNotifications();
        refetchSessions();
        
        // Show prominent notification
        toast.success(
          `üîî Y√äU C·∫¶U M·ªöI: ${notification.userProfile?.name || "User"} c·∫ßn h·ªó tr·ª£!`,
          {
            duration: 8000,
            style: {
              background: '#10B981',
              color: 'white',
              fontWeight: 'bold',
            },
          },
        );
      },
    });

    setIsLoading(false);
    return cleanup;
  }, [refetchNotifications, refetchSessions]);

  // Format time duration
  const formatDuration = (seconds: number) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, "0")}`;
  };

  // Render pending request card
  const renderPendingRequest = (request: PendingRequest) => (
    <Card key={request.id} className="mb-4 border-l-4 border-l-warning hover:shadow-lg transition-all">
      <CardBody className="p-4">
        <div className="flex items-start justify-between">
          <div className="flex items-start gap-3">
            <Avatar
              name={request.userProfile?.name || "Guest"}
              size="sm"
              className="flex-shrink-0"
            />
            <div>
              <div className="flex items-center gap-2">
                <h4 className="font-semibold">
                  {request.userProfile?.name || "Guest User"}
                </h4>
                <Badge color="warning" size="sm" className="animate-pulse">
                  üîî ƒêang ch·ªù
                </Badge>
              </div>
              <p className="text-sm text-gray-600">
                {request.userProfile?.email || "No email"}
              </p>
              <p className="mt-2 text-sm bg-gray-50 p-2 rounded italic">
                &ldquo;{request.initialMessage}&rdquo;
              </p>
              <div className="mt-2 flex items-center gap-2 text-xs text-red-600 font-medium">
                <Clock size={14} />
                ƒê√£ ch·ªù {formatDuration(request.timeElapsed)} ‚è∞
              </div>
            </div>
          </div>
          <div className="flex gap-2">
            <Button
              size="sm"
              color="primary"
              startContent={<CheckCircle size={16} />}
              onPress={() => handleAcceptRequest(request.id)}
              isLoading={acceptMutation.isPending}
              className="animate-pulse"
            >
              NH·∫¨N NGAY
            </Button>
          </div>
        </div>
      </CardBody>
    </Card>
  );

  // Render active session card
  const renderActiveSession = (session: ActiveSession) => (
    <Card key={session.id} className="mb-4 border-l-4 border-l-success hover:shadow-lg transition-all">
      <CardBody className="p-4">
        <div className="flex items-start justify-between">
          <div className="flex items-start gap-3">
            <Avatar
              name={session.userProfile?.name || "Guest"}
              size="sm"
              className="flex-shrink-0"
            />
            <div>
              <div className="flex items-center gap-2">
                <h4 className="font-semibold">
                  {session.userProfile?.name || "Guest User"}
                </h4>
                <Badge color="success" size="sm">
                  <div className="flex items-center gap-1">
                    <div className="w-2 h-2 rounded-full bg-success-500 animate-ping" />
                    ‚úÖ ƒêang k·∫øt n·ªëi
                  </div>
                </Badge>
              </div>
              <p className="text-sm text-gray-600">
                {session.userProfile?.email || "No email"}
              </p>
              <div className="mt-2 flex items-center gap-2 text-xs text-green-600 font-medium">
                <Phone size={14} />
                Th·ªùi gian: {formatDuration(session.duration)} üìû
              </div>
            </div>
          </div>
          <div className="flex gap-2">
            <Button
              size="sm"
              color="primary"
              variant="flat"
              startContent={<ChatCircle size={16} />}
              onPress={() => handleOpenChat(session)}
            >
              üí¨ Chat
            </Button>
            <Button
              size="sm"
              color="danger"
              variant="flat"
              startContent={<X size={16} />}
              onPress={() => handleEndSession(session.id)}
              isLoading={endMutation.isPending}
            >
              K·∫øt th√∫c
            </Button>
          </div>
        </div>
      </CardBody>
    </Card>
  );

  if (isLoading) {
    return (
      <div className="flex h-[calc(100vh-80px)] items-center justify-center">
        <div className="text-center">
          <div className="mb-4 h-8 w-8 animate-spin rounded-full border-4 border-blue-500 border-t-transparent mx-auto" />
          <p>ƒêang t·∫£i d·ªØ li·ªáu real-time...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="h-[calc(100vh-80px)] space-y-4">
      {/* Header */}
      <div className="rounded-lg bg-white p-6 shadow-sm border">
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-3xl font-bold text-gray-800">
              Human Support Dashboard
            </h1>
            <p className="mt-2 text-gray-500">
              Qu·∫£n l√Ω h·ªó tr·ª£ tr·ª±c ti·∫øp v·ªõi ng∆∞·ªùi d√πng (Real-time)
            </p>
            <p className="text-xs text-gray-400 mt-1">
              C·∫≠p nh·∫≠t cu·ªëi: {new Date(lastUpdate).toLocaleTimeString("vi-VN")}
            </p>
          </div>
          <div className="flex gap-4">
            <div className="text-center">
              <div className="text-3xl font-bold text-orange-600">
                {pendingRequests.length}
              </div>
              <div className="text-sm text-gray-500">üîî ƒêang ch·ªù</div>
            </div>
            <div className="text-center">
              <div className="text-3xl font-bold text-green-600">
                {activeSessions.length}
              </div>
              <div className="text-sm text-gray-500">‚úÖ ƒêang k·∫øt n·ªëi</div>
            </div>
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="rounded-lg bg-white shadow-sm border">
        <Tabs aria-label="Human support tabs" className="p-4">
          <Tab
            key="pending"
            title={
              <div className="flex items-center gap-2">
                <Clock size={18} />
                <span>üîî Y√™u c·∫ßu ch·ªù</span>
                {pendingRequests.length > 0 && (
                  <Badge color="warning" size="sm" className="animate-bounce">
                    {pendingRequests.length}
                  </Badge>
                )}
              </div>
            }
          >
            <div className="mt-4">
              {pendingRequests.length === 0 ? (
                <div className="py-12 text-center text-gray-500">
                  <ChatCircle size={48} className="mx-auto mb-4 opacity-50" />
                  <p className="text-lg font-medium">Kh√¥ng c√≥ y√™u c·∫ßu h·ªó tr·ª£ n√†o ƒëang ch·ªù</p>
                  <p className="text-sm mt-2">
                    üîÑ Trang s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t m·ªói 2 gi√¢y khi c√≥ y√™u c·∫ßu m·ªõi
                  </p>
                  <div className="mt-4 flex items-center justify-center gap-2 text-xs text-gray-400">
                    <div className="w-2 h-2 rounded-full bg-green-500 animate-ping" />
                    <span>ƒêang l·∫Øng nghe real-time...</span>
                  </div>
                </div>
              ) : (
                <div className="space-y-4">
                  <div className="text-sm text-orange-600 font-medium mb-4">
                    ‚ö†Ô∏è C√≥ {pendingRequests.length} y√™u c·∫ßu c·∫ßn x·ª≠ l√Ω ngay!
                  </div>
                  {pendingRequests.map(renderPendingRequest)}
                </div>
              )}
            </div>
          </Tab>

          <Tab
            key="active"
            title={
              <div className="flex items-center gap-2">
                <Users size={18} />
                <span>üí¨ Phi√™n ƒëang ho·∫°t ƒë·ªông</span>
                {activeSessions.length > 0 && (
                  <Badge color="success" size="sm">
                    {activeSessions.length}
                  </Badge>
                )}
              </div>
            }
          >
            <div className="mt-4">
              {activeSessions.length === 0 ? (
                <div className="py-12 text-center text-gray-500">
                  <Users size={48} className="mx-auto mb-4 opacity-50" />
                  <p className="text-lg font-medium">Kh√¥ng c√≥ phi√™n h·ªó tr·ª£ n√†o ƒëang ho·∫°t ƒë·ªông</p>
                  <p className="text-sm mt-2">
                    üëÜ Nh·∫≠n y√™u c·∫ßu t·ª´ tab "Y√™u c·∫ßu ch·ªù" ƒë·ªÉ b·∫Øt ƒë·∫ßu h·ªó tr·ª£
                  </p>
                </div>
              ) : (
                <div className="space-y-4">
                  <div className="text-sm text-green-600 font-medium mb-4">
                    ‚úÖ ƒêang h·ªó tr·ª£ {activeSessions.length} ng∆∞·ªùi d√πng
                  </div>
                  {activeSessions.map(renderActiveSession)}
                </div>
              )}
            </div>
          </Tab>
        </Tabs>
      </div>
    </div>
  );
} 